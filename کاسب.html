<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>کاسب — نسخه نهایی</title>
<style>
:root{
  --accent:#1976d2;
  --green:#4caf50;
  --orange:#ff9800;
  --gray:#607d8b;
  --danger:#e53935;
  --card:#ffffff;
  --bg:#f4f6f8;
  --radius:18px;
}
*{box-sizing:border-box;font-family:Tahoma, Arial, sans-serif}
body{margin:0;background:var(--bg);color:#111}
.header{background:var(--accent);color:#fff;padding:28px;text-align:center;font-size:28px;font-weight:700}
.container{padding:18px;max-width:820px;margin:0 auto}
.menu-btn{display:block;width:100%;padding:26px;border-radius:26px;border:0;margin:14px 0;font-size:20px;color:#fff;cursor:pointer;text-align:center}
.menu-btn.stock{background:var(--accent)}
.menu-btn.sale{background:var(--green)}
.menu-btn.cust{background:var(--orange)}
.menu-btn.trans{background:var(--gray)}
.section{background:var(--card);padding:16px;border-radius:14px;margin-bottom:12px;display:none;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
.field{margin:8px 0}
.input, select {width:100%;padding:12px;border-radius:10px;border:1px solid #e2e6ea;font-size:16px}
.row{display:flex;gap:10px}
.row .input{flex:1}
.btn{padding:10px 12px;border-radius:12px;border:0;cursor:pointer;font-size:15px}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{background:#f1f3f5;color:#333;border:1px solid #e6e9ee}
.btn.danger{background:var(--danger);color:#fff}
.btn.gray{background:var(--gray);color:#fff}
.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:15px}
.table th,.table td{border:1px solid #eef2f6;padding:10px;text-align:center}
.small{font-size:13px;color:#666;margin-top:8px}
.action-small{padding:6px 8px;border-radius:10px;border:0;cursor:pointer;font-size:13px}
.action-edit{background:#1976d2;color:#fff;border-radius:10px}
.action-del{background:#e53935;color:#fff;border-radius:10px}
.action-settle{background:#607d8b;color:#fff;border-radius:10px}
.kv{font-weight:700}
.total{font-weight:800;text-align:left;margin-top:12px;font-size:16px}
.footer{padding:16px;text-align:center;color:#666;font-size:13px}

/* responsive */
@media(max-width:600px){
  .menu-btn{padding:20px;font-size:18px;border-radius:20px}
  .header{font-size:22px;padding:18px}
}
</style>
</head>
<body>
<header class="header">کاسب | نسخهٔ چندکالایی نهایی</header>
<main class="container">

<!-- Menu buttons (accordion-like) -->
<button class="menu-btn stock" data-target="stock">انبار ▾</button>
<section id="stock" class="section" aria-hidden="true">
  <h3>مدیریت انبار</h3>
  <div class="field"><input id="pname" class="input" placeholder="نام کالا"></div>
  <div class="field"><input id="punit" class="input" placeholder="واحد (عدد، کیلو، بسته...)"></div>
  <div class="row">
    <input id="pprice" class="input" type="number" placeholder="قیمت فروش">
    <input id="pqty" class="input" type="number" placeholder="موجودی">
  </div>
  <div class="row" style="margin-top:10px">
    <button id="saveProd" class="btn primary">ثبت/بروزرسانی کالا</button>
    <button id="clearProd" class="btn ghost">پاک‌سازی فرم</button>
  </div>

  <h4 class="small">لیست کالاها</h4>
  <table class="table" id="prodTable">
    <thead><tr><th>#</th><th>نام</th><th>واحد</th><th>قیمت</th><th>موجودی</th><th>عملیات</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<button class="menu-btn sale" data-target="sale">فروش چندکالایی ▾</button>
<section id="sale" class="section" aria-hidden="true">
  <h3>فروش چندکالایی</h3>
  <div class="small">برای هر کالا تعداد را تنظیم کنید و «افزودن به سبد» را بزنید. سپس ثبت فروش را انتخاب کنید.</div>

  <table class="table" id="sellList">
    <thead><tr><th>انتخاب</th><th>نام</th><th>واحد</th><th>موجودی</th><th>قیمت</th><th>تعداد</th><th>عملیات</th></tr></thead>
    <tbody></tbody>
  </table>

  <h4 class="small">سبد خرید</h4>
  <table class="table" id="cartTable">
    <thead><tr><th>#</th><th>نام</th><th>واحد</th><th>تعداد</th><th>قیمت واحد</th><th>جمع</th><th>عملیات</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="total">جمع کل: <span id="cartTotal">۰</span> تومان</div>

  <div class="row" style="margin-top:12px">
    <select id="payType" class="input" style="width:48%"><option value="cash">نقدی</option><option value="credit">نسیه</option></select>
    <select id="payCustomer" class="input" style="width:48%"><option value="">— انتخاب مشتری —</option></select>
  </div>

  <div style="margin-top:10px" class="row">
    <button id="addToCartBtn" class="btn primary">افزودن انتخاب‌شده به سبد</button>
    <button id="completeSaleBtn" class="btn ghost">ثبت فروش</button>
  </div>
</section>

<button class="menu-btn cust" data-target="customers">مشتریان ▾</button>
<section id="customers" class="section" aria-hidden="true">
  <h3>مشتریان و نسیه</h3>
  <div class="field"><input id="cname" class="input" placeholder="نام مشتری (الزامی)"></div>
  <div class="field"><input id="cphone" class="input" placeholder="تلفن (اختیاری)"></div>
  <div class="row">
    <button id="saveCust" class="btn primary">ثبت/بروزرسانی مشتری</button>
    <button id="clearCust" class="btn ghost">پاک‌سازی فرم</button>
  </div>

  <h4 class="small">لیست مشتریان</h4>
  <table class="table" id="custTable">
    <thead><tr><th>#</th><th>نام</th><th>تلفن</th><th>بدهی</th><th>عملیات</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="small" style="margin-top:10px">برای تسویه روی دکمهٔ «تسویه» کلیک کنید؛ ویرایش و حذف نیز کنار آن قرار دارند.</div>
</section>

<button class="menu-btn trans" data-target="transactions">تراکنش‌ها ▾</button>
<section id="transactions" class="section" aria-hidden="true">
  <h3>تراکنش‌ها</h3>
  <div class="small">هر فروش یک تراکنش با تاریخ و ساعت ثبت می‌شود.</div>
  <div style="margin-top:10px">
    
    <div style="display:flex;gap:8px;margin-top:8px">
      
      
    </div>
    <div style="margin-top:8px">
      
      
    </div>
  </div>

  <table class="table" id="transTable">
    <thead><tr><th>تاریخ و ساعت</th><th>آیتم‌ها</th><th>جمع</th><th>نوع</th><th>مشتری</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<footer class="footer">آفلاین — داده‌ها در مرورگر شما ذخیره می‌شوند</footer>
</main>

<script>
/* Persistence keys */
const KP='kaseb_products_v2', KC='kaseb_customers_v2', KT='kaseb_transactions_v2', KCART='kaseb_cart_v2';
let products = JSON.parse(localStorage.getItem(KP)||'[]');
let customers = JSON.parse(localStorage.getItem(KC)||'[]');
let transactions = JSON.parse(localStorage.getItem(KT)||'[]');
let cart = JSON.parse(localStorage.getItem(KCART)||'[]');

/* Utility */
function saveAll(){
  localStorage.setItem(KP, JSON.stringify(products));
  localStorage.setItem(KC, JSON.stringify(customers));
  localStorage.setItem(KT, JSON.stringify(transactions));
  localStorage.setItem(KCART, JSON.stringify(cart));
}
function formatNum(n){ return Number(n).toLocaleString('fa-IR'); }
function nowStr(){ return new Date().toLocaleString('fa-IR'); }

/* Accordion behavior: each button toggles its section under it */
document.querySelectorAll('.menu-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const target = btn.dataset.target;
    const sec = document.getElementById(target);
    // toggle this, hide others
    document.querySelectorAll('.section').forEach(s=>{ if(s.id!==target) s.style.display='none'; });
    sec.style.display = (sec.style.display==='block')? 'none' : 'block';
    renderAll();
    // scroll into view for mobile
    if(sec.style.display==='block') sec.scrollIntoView({behavior:'smooth'});
  });
});

/* ---------- Inventory ---------- */
let editingProductId = null;
const prodTableTbody = ()=> document.querySelector('#prodTable tbody');

function renderProducts(){
  const tbody = prodTableTbody();
  tbody.innerHTML='';
  if(products.length===0){ tbody.innerHTML='<tr><td colspan="6" class="small">انبار خالی است</td></tr>'; return; }
  products.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.unit}</td><td>${formatNum(p.price)}</td><td>${p.qty}</td>
      <td>
        <button class="action-small action-edit" onclick="startEditProduct(${p.id})">ویرایش</button>
        <button class="action-small action-del" onclick="removeProduct(${p.id})">حذف</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Add or update product */
document.getElementById('saveProd').addEventListener('click', ()=>{
  const name = document.getElementById('pname').value.trim();
  const unit = document.getElementById('punit').value.trim() || 'عدد';
  const price = Number(document.getElementById('pprice').value||0);
  const qty = Number(document.getElementById('pqty').value||0);
  if(!name) return alert('نام کالا لازم است');
  if(editingProductId!==null){
    const idx = products.findIndex(p=>p.id===editingProductId);
    if(idx>=0){
      products[idx].name = name; products[idx].unit = unit; products[idx].price = price; products[idx].qty = qty;
      editingProductId = null;
      document.getElementById('saveProd').innerText='ثبت/بروزرسانی کالا';
    }
  } else {
    const id = products.length? products[products.length-1].id+1 : 1;
    products.push({id,name,unit,price,qty});
  }
  clearProdForm(); saveAll(); renderAll();
});

function startEditProduct(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  editingProductId = id;
  document.getElementById('pname').value = p.name;
  document.getElementById('punit').value = p.unit;
  document.getElementById('pprice').value = p.price;
  document.getElementById('pqty').value = p.qty;
  document.getElementById('saveProd').innerText='بروزرسانی کالا';
}

document.getElementById('clearProd').addEventListener('click', clearProdForm);
function clearProdForm(){
  editingProductId = null;
  document.getElementById('pname').value=''; document.getElementById('punit').value=''; document.getElementById('pprice').value=''; document.getElementById('pqty').value='';
  document.getElementById('saveProd').innerText='ثبت/بروزرسانی کالا';
}

function removeProduct(id){
  if(!confirm('آیا از حذف این کالا مطمئنید؟')) return;
  // remove; also remove from cart if exists and return qty
  const prod = products.find(p=>p.id===id);
  products = products.filter(p=>p.id!==id);
  cart = cart.filter(c=> {
    if(c.id===id) return false;
    return true;
  });
  saveAll(); renderAll();
}

/* ---------- Customers ---------- */
let editingCustomerId = null;
const custTbody = ()=> document.querySelector('#custTable tbody');

document.getElementById('saveCust').addEventListener('click', ()=>{
  const name = document.getElementById('cname').value.trim();
  const phone = document.getElementById('cphone').value.trim() || '—';
  if(!name) return alert('نام مشتری لازم است');
  if(editingCustomerId!==null){
    const idx = customers.findIndex(c=>c.id===editingCustomerId);
    if(idx>=0){ customers[idx].name = name; customers[idx].phone = phone; editingCustomerId = null; document.getElementById('saveCust').innerText='ثبت/بروزرسانی مشتری'; }
  } else {
    const id = customers.length? customers[customers.length-1].id+1 : 1;
    customers.push({id,name,phone,debt:0});
  }
  document.getElementById('cname').value=''; document.getElementById('cphone').value=''; saveAll(); renderAll();
});

function renderCustomers(){
  const tbody = custTbody();
  tbody.innerHTML='';
  if(customers.length===0){ tbody.innerHTML='<tr><td colspan="5" class="small">هیچ مشتری‌ای ثبت نشده</td></tr>'; return; }
  customers.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.id}</td><td>${c.name}</td><td>${c.phone}</td><td>${formatNum(c.debt||0)}</td>
      <td>
        <button class="action-small action-edit" onclick="startEditCustomer(${c.id})">ویرایش</button>
        <button class="action-small action-del" onclick="removeCustomer(${c.id})">حذف</button>
        <button class="action-small action-settle" onclick="settleCustomer(${c.id})">تسویه</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // fill select for payment
  const sel = document.getElementById('payCustomer');
  sel.innerHTML = '<option value="">— انتخاب مشتری —</option>';
  customers.forEach(c=> sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
}

function startEditCustomer(id){
  const c = customers.find(x=>x.id===id); if(!c) return;
  editingCustomerId = id;
  document.getElementById('cname').value = c.name;
  document.getElementById('cphone').value = c.phone==='—' ? '' : c.phone;
  document.getElementById('saveCust').innerText='بروزرسانی مشتری';
}

function removeCustomer(id){
  if(!confirm('آیا از حذف این مشتری مطمئنید؟')) return;
  customers = customers.filter(c=>c.id!==id);
  saveAll(); renderAll();
}

function settleCustomer(id){
  const c = customers.find(x=>x.id===id); if(!c) return;
  const v = Number(prompt('مبلغ پرداخت را وارد کنید', 0));
  if(!v || v<=0) return alert('مبلغ نامعتبر');
  if(v > (c.debt||0)) return alert('بیشتر از بدهی');
  c.debt -= v; saveAll(); renderAll(); alert('تسویه ثبت شد');
}

/* ---------- Sales / Cart ---------- */
const sellTbody = ()=> document.querySelector('#sellList tbody');
const cartTbody = ()=> document.querySelector('#cartTable tbody');

function renderSellList(){
  const tb = sellTbody();
  tb.innerHTML='';
  if(products.length===0){ tb.innerHTML = '<tr><td colspan="7" class="small">انبار خالی است</td></tr>'; return; }
  products.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" data-id="${p.id}"></td>
      <td>${p.name}</td><td>${p.unit}</td><td>${p.qty}</td><td>${formatNum(p.price)}</td>
      <td><input type="number" min="1" max="${p.qty}" value="1" data-id="${p.id}" style="width:90px"></td>
      <td><button class="action-small action-edit" onclick="startEditProductFromSell(${p.id})">ویرایش</button></td>`;
    tb.appendChild(tr);
  });
}

function startEditProductFromSell(id){ startEditProduct(id); document.querySelectorAll('.menu-btn')[0].click(); }

document.getElementById('addToCartBtn').addEventListener('click', ()=>{
  // add all checked items with their qtys
  const rows = Array.from(document.querySelectorAll('#sellList tbody tr'));
  let warnings=[];
  rows.forEach(r=>{
    const chk = r.querySelector('input[type=checkbox]');
    if(!chk || !chk.checked) return;
    const id = Number(chk.dataset.id);
    const qtyInput = r.querySelector('input[type=number]');
    let q = Number(qtyInput.value||0);
    const prod = products.find(p=>p.id===id);
    if(!prod) return;
    if(q > prod.qty){ warnings.push(prod.name); q = prod.qty; }
    if(q<=0) return;
    const idx = cart.findIndex(c=>c.id===id);
    if(idx>=0) cart[idx].qty += q;
    else cart.push({id:prod.id,name:prod.name,unit:prod.unit,price:prod.price,qty:q});
    prod.qty -= q;
  });
  if(warnings.length) alert('مقادیر بیشتر از موجودی برای: ' + warnings.join(', ') + ' تعدیل شد');
  saveAll(); renderAll();
});

function renderCart(){
  const tb = cartTbody();
  tb.innerHTML='';
  if(cart.length===0){ tb.innerHTML = '<tr><td colspan="7" class="small">سبد خرید خالی است</td></tr>'; document.getElementById('cartTotal').innerText='۰'; return; }
  let sum=0;
  cart.forEach((c,i)=>{
    const line = c.price * c.qty; sum += line;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${c.name}</td><td>${c.unit}</td><td>${c.qty}</td><td>${formatNum(c.price)}</td><td>${formatNum(line)}</td>
      <td>
        <button class="action-small action-edit" onclick="editCartItem(${i})">ویرایش</button>
        <button class="action-small action-del" onclick="removeCartItem(${i})">حذف</button>
      </td>`;
    tb.appendChild(tr);
  });
  document.getElementById('cartTotal').innerText = formatNum(sum);
}

/* edit cart item */
function editCartItem(index){
  const item = cart[index];
  const newQty = Number(prompt('تعداد جدید برای ' + item.name, item.qty));
  if(!newQty || newQty<=0) return alert('تعداد نامعتبر');
  const prod = products.find(p=>p.id===item.id);
  const available = prod ? prod.qty + item.qty : item.qty;
  if(newQty > available) return alert('بیشتر از موجودی مجاز نیست');
  if(prod) prod.qty = available - newQty;
  cart[index].qty = newQty;
  saveAll(); renderAll();
}

/* remove cart item */
function removeCartItem(index){
  const it = cart[index];
  const prod = products.find(p=>p.id===it.id);
  if(prod) prod.qty += it.qty;
  cart.splice(index,1);
  saveAll(); renderAll();
}

/* Complete sale */
document.getElementById('completeSaleBtn').addEventListener('click', ()=>{
  if(cart.length===0) return alert('سبد خرید خالی است');
  const payType = document.getElementById('payType').value;
  const custId = Number(document.getElementById('payCustomer').value || 0);
  const total = cart.reduce((s,c)=> s + c.price*c.qty, 0);
  if(payType==='credit' && !custId) return alert('برای فروش نسیه انتخاب مشتری الزامی است');
  if(payType==='credit'){
    const cust = customers.find(c=>c.id===custId);
    if(cust) cust.debt = (cust.debt||0) + total;
  }
  // record transaction
  const itemsDesc = cart.map(c=> `${c.name}×${c.qty}`).join(' — ');
  transactions.unshift({date: nowStr(), items: itemsDesc, total, type: payType, customer: custId? (customers.find(c=>c.id===custId)||{}).name : ''});
  // clear cart
  cart = []; saveAll(); renderAll();
  alert('فروش ثبت شد: ' + formatNum(total) + ' تومان');
});

/* ---------- Transactions render & filter ---------- */
function renderTransactions(filterCustomer, from, to){
  const tbody = document.querySelector('#transTable tbody');
  tbody.innerHTML='';
  let list = transactions.slice();
  if(filterCustomer) list = list.filter(t=> t.customer && t.customer.toLowerCase().includes(filterCustomer.toLowerCase()));
  if(from){ const fromD = new Date(from); list = list.filter(t=> new Date(t.date) >= fromD); }
  if(to){ const toD = new Date(to); toD.setHours(23,59,59,999); list = list.filter(t=> new Date(t.date) <= toD); }
  if(list.length===0) { tbody.innerHTML='<tr><td colspan="5" class="small">تراکنشی یافت نشد</td></tr>'; return; }
  list.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date}</td><td style="text-align:left">${t.items}</td><td>${formatNum(t.total)}</td><td>${t.type}</td><td>${t.customer||'—'}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Render all ---------- */
function renderAll(){
  renderProducts(); renderSellList(); renderCart(); renderCustomers(); renderTransactions(document.getElementById('filterCustomer')?.value||'', document.getElementById('fromDate')?.value||'', document.getElementById('toDate')?.value||'');
}

/* Filters */
document.getElementById('applyFilter').addEventListener('click', ()=>{
  renderTransactions(document.getElementById('filterCustomer').value, document.getElementById('fromDate').value, document.getElementById('toDate').value);
});
document.getElementById('clearFilter').addEventListener('click', ()=>{
  document.getElementById('filterCustomer').value=''; document.getElementById('fromDate').value=''; document.getElementById('toDate').value='';
  renderAll();
});

/* initial */
if(!Array.isArray(products)) products=[];
if(!Array.isArray(customers)) customers=[];
if(!Array.isArray(transactions)) transactions=[];
if(!Array.isArray(cart)) cart=[];
renderAll();
</script>
</body>
</html>
